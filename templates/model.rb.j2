{% set backup = item.value -%}

Template.new(:{{ item.key }}, "{{ microservice_name }} {{ microservice_env }}") do
  split_into_chunks_of {{ backup_config_chunks }}

  store_with SFTP do |server|
    server.keep       = "{{ backup.keep }}"
  end

{% if backup.archives is defined %}
  archive :archive do |archive|
{% for archive in backup.archives.add %}
    archive.add '{{ archive }}'
{% endfor %}
{% for archive in backup.archives.exclude %}
    archive.exclude '{{ archive }}'
{% endfor %}
  end
{% endif %}

{% if backup.postgresql is defined %}
{% for database in backup.postgresql %}
database PostgreSQL, :{{ database }} do |db|
  db.name               = "{{ database }}"
end

{% endfor %}
# backup users/roles/etc
database PostgreSQL, :all do |db|
  db.name               = :all
  db.additional_options = ["--globals-only"]
end
{% endif %}

{% if backup.mongodb is defined %}
{% for database in backup.mongodb %}
database MongoDB, :{{ database }} do |db|
  db.name               = "{{ database }}"
end
{% endfor %}
{% endif %}

end